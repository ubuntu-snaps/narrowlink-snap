#!/bin/sh -e

if [ -z "$(snapctl get gateway.domain)" ]; then
	snapctl set gateway.domain="gateway.iotapp.cloud";
fi

if [ -z "$(snapctl get gateway.wss.port)" ]; then
	snapctl set gateway.wss.port="443";
fi

if [ -z "$(snapctl get gateway.ws.port)" ]; then
	snapctl set gateway.ws.port="80";
fi

if [ -z "$(snapctl get gateway.acme.email)" ]; then
	snapctl set gateway.acme.email="triobird@163.com";
fi

if [ -z "$(snapctl get agent.uid)" ]; then
	snapctl set agent.uid="00000000-0000-0000-0000-000000000000";
fi

if [ -z "$(snapctl get agent.publish.subdomain)" ]; then
	snapctl set agent.publish.subdomain="iotbox.iotapp.cloud";
fi

cat > $SNAP_DATA/gateway.yaml <<EOF
name: narrowlink-gateway
secret: [1, 2, 3, 4, 5, 6, 7, 8]
services:
- !Wss
  domains: ["$(snapctl get gateway.domain)"]
  listen_addr: "0.0.0.0:$(snapctl get gateway.wss.port)"
  tls_config: !Acme
    email: "$(snapctl get gateway.acme.email)"
    challenge_type: Http01
    directory_url: https://acme-v02.api.letsencrypt.org/directory
- !Ws
  domains: ["$(snapctl get gateway.domain)"]
  listen_addr: "0.0.0.0:$(snapctl get gateway.ws.port)"
EOF

cat > $SNAP_DATA/token-generator.yaml <<EOF
secret: [1,2,3,4,5,6,7,8]
tokens:
  - !Agent
    uid: $(snapctl get agent.uid)
    name: $(hostname)
    exp: 2051193600 # 2035-01-01T00:00:00+08:00
  - !AgentPublish
    uid: 00000000-0000-0000-0000-000000000000
    name: iotbox-reel-01
    exp: 2051193600 # 2035-01-01T00:00:00+08:00
    publish_hosts:
      - host: $(hostname).$(snapctl get agent.publish.subdomain)
        port: 0
        connect:
          host: 127.0.0.1
          port: 80
          protocol: HTTP
      - host: admin.$(hostname).$(snapctl get agent.publish.subdomain)
        port: 0
        connect:
          host: 127.0.0.1
          port: 8100
          protocol: HTTP
      - host: portainer.$(hostname).$(snapctl get agent.publish.subdomain)
        port: 0
        connect:
          host: 127.0.0.1
          port: 9443
          protocol: TCP          
EOF

$SNAP/narrowlink-token-generator -c $SNAP_DATA/token-generator.yaml > $SNAP_DATA/tokens

cat > $SNAP_DATA/agent.yaml <<EOF
endpoints:
  - !SelfHosted 
    gateway: $(snapctl get gateway.domain):$(snapctl get gateway.wss.port)
    token: $(sed -n '2p' $SNAP_DATA/tokens)
    publish:
      - $(sed -n '4p' $SNAP_DATA/tokens)
EOF

snapctl restart "$SNAP_INSTANCE_NAME"

